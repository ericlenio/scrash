#! /usr/bin/env bash

export SCR_PORT=4553
export SCR_ENV=dev
eval $(node -r fs -r path -e 'const h=fs.realpathSync(path.join(process.argv[1],"..")); const p=require(path.join(h,"package.json")); console.log(`export SCR_HOME=${h} SCR_VERSION=${p.version}`);' -- $0)
shell_init_args=(-s 1)

usage() {
  echo "Usage: $0 [-h][-C][-p port]
Options:
-h       this help
-C       clear the cache
-p port  port number of the Server.js process
"
}

while builtin getopts "hCp:" opt; do
  case $opt in
    (h)
      usage
      exit
      ;;
    (p)
      SCR_PORT=$OPTARG
      ;;
    (C)
      shell_init_args+=(-C)
      ;;
  esac
done

url="http://127.0.0.1:$SCR_PORT/scr-get-bash-functions"
eval -- "$(curl -S -f -s --compressed $url)"
-shell-init "${shell_init_args[@]}"
