# vim:filetype=bash
SCR_TEST_ASSERTIONS=(
  # basic
  '-test-group BASIC'
  '[ $SCR_TEST_GROUP = BASIC ]'
  '[[ $SCR_PORT =~ ^[0-9]+$ ]]'
  'len=8'
  'v=$(-random-string $len)'
  '[ $len = ${#v} ]'
  '-ws-hello-world >/dev/null'
  '-ws-hello-world | grep -q "hello world"'
  'session_id=$(screen --generate-session-id)'
  '[ ${#session_id} -gt 0 ]'
  '[[ $session_id =~ ^[-[:alnum:]]+$ ]]'
  '[ -d $SCR_TMPDIR ]'
  '[ $SCR_ENV = test ]'

  # sudo
  '-test-group SUDO'
  '-s nobody -ws-hello-world | grep -q hello'
  '[ $(-s nobody whoami) = nobody ]'
  'echo ok | -copy-to-clipboard'
  '[ ok = $(-clipboard) ]'
  't1=$SCR_TMPDIR/t1'
  'printf "/^root\015ve\003:q\015" > $t1'
  'v -s $t1 /etc/passwd'
  '[ root = $(-clipboard) ]'

  # vim
  '-test-group VIM'
  '[ ${#EDITOR} -gt 0 ]'
  'v --version >/dev/null'
  '[ -e $EDITOR ]'
  'rm $EDITOR'
  'v --version >/dev/null'
  '[ -e $EDITOR ]'
  'echo ok | -copy-to-clipboard'
  '[ ok = $(-clipboard) ]'
  't1=$SCR_TMPDIR/t1'
  'printf "/^root\015ve\003:q\015" > $t1'
  'v -s $t1 /etc/passwd'
  #'rm $t1'
  '[ root = $(-clipboard) ]'

  # vim inside gnu screen
  '-test-group VIM.SCREEN'
  'v --version >/dev/null'
  'session_id=$(screen --generate-session-id)'
  'screen -S $session_id -d -m'
  'r=$(-random-string)'
  'echo $r | -copy-to-clipboard'
  '[ $r = $(-clipboard) ]'
  't1=$SCR_TMPDIR/t1'
  'f1=$SCR_TMPDIR/f1'
  'mkfifo $f1'
  # create a vim script file to select/copy the word "root"
  'printf "/^root\015ve\003:!echo $r > $f1\015:q\015" > $t1'
  'screen -S $session_id -X screen bash -c "v -s $t1 /etc/passwd"'
  'read ans < $f1'
  '[ "$ans" = $r ]'
  '[ root = $(-clipboard) ]'
  '-test-group VIM.SCREEN.SSH'
    'r=$(-random-string)'
    # flush clipboard
    'echo $r | -copy-to-clipboard'
    '[ $r = $(-clipboard) ]'
    # create a vim script file to select/copy the word "nobody"
    'printf "/^nobody\015ve\003:!echo $r > $f1\015:q\015" > $t1'
    'cpfile=$SCR_TMPDIR/ssh-cp'
    # start a control master: check that vim inside gnu screen can handle a
    # change in SCR_PORT
    '-ssh-not-strict -f -N -M -S $cpfile -oBatchMode=yes localhost'
    # update SCR_PORT
    '-ssh-not-strict -S $cpfile localhost screen -u -S $session_id -X select -'
    # try copying a word inside vim to the clipboard over the new SCR_PORT
    'screen -S $session_id -X screen bash -c "v -s $t1 /etc/passwd"'
    'read ans < $f1'
    '[ "$ans" = $r ]'
    '[ nobody = $(-clipboard) ]'
    'VIM.SCREEN.SSH'
  '-test-group VIM.CLEANUP'
    '-ssh-not-strict -N -S $cpfile -O stop localhost'
    'rm $t1 $f1'
    'screen -S $session_id -X quit'

  # start/stop gnu screen
  '-test-group SCREEN'
  'screen -S $session_id -d -m'
  'screen -ls | grep -q $session_id'
  'screen -S $session_id -X quit'
  '! screen -ls | grep -q $session_id'

  'SCR_TEST_STY=$(screen --generate-session-id)'
  'screen -S $SCR_TEST_STY -d -m'
  'screen -ls | grep -q $SCR_TEST_STY'
  '-test-sty-launch $SCR_TEST_STY'
  'screen -S $SCR_TEST_STY -X quit'
  '! screen -ls | grep -q $SCR_TEST_STY'

  # ssh
  '-test-group SSH'
  'h=$(-ssh-localhost hostname)'
  '[ $h = $(hostname) ]'
  # remote SCR_PORT from ssh session should always be different from parent shell
  'remote_port=$(eval $(-ssh-localhost declare -p SCR_PORT); echo $SCR_PORT)'
  '[ $remote_port != $SCR_PORT ]'
  '[[ $remote_port =~ ^[0-9]+$ ]]'

  # md5
  '-test-group MD5'
  's="hello world"'
  't=$(mktemp) && echo "$s" > $t'
  '[ $(-md5 $t) = 6f5902ac237024bdd0c176cb93063dc4 ]'
  '[ $(echo "$s" | -md5) = 6f5902ac237024bdd0c176cb93063dc4 ]'
  '! -md5 /no-such-file'
  'rm $t'

  # clipboard
  '-test-group CLIPBOARD'
  'len=8'
  'r=$(-random-string $len)'
  '[ $len = ${#r} ]'
  'echo -n $r | -copy-to-clipboard'
  'r2=$(-clipboard)'
  '[ $r = $r2 ]'
  '-copy-to-clipboard /etc/passwd'
  '[ $(-clipboard | -md5) = $(-md5 /etc/passwd) ]'

  # clipboard over ssh
  't=$(mktemp) && uname -a > $t'
  '-ssh-localhost -copy-to-clipboard $t'
  '[ $(-md5 $t) = $(-clipboard | -md5) ]'
  'rm $t'
)
