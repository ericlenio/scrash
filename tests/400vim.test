# vim:filetype=bash
[ ${#EDITOR} -gt 0 ]
vim --version >/dev/null
[ -e $EDITOR ]
rm $EDITOR
vim --version >/dev/null
[ -e $EDITOR ]
echo ok | -copy-to-clipboard
[ ok = $(-clipboard) ]
t1=$SCR_TMPDIR/t1
printf "/^root\015ve\003:q\015" > $t1
vim -s $t1 /etc/passwd
#'rm $t1
[ root = $(-clipboard) ]

# vim inside gnu screen
vim --version >/dev/null
session_id=$(screen --generate-session-id)
screen -S $session_id -d -m
r=$(-random-string)
echo $r | -copy-to-clipboard
[ $r = $(-clipboard) ]
t1=$SCR_TMPDIR/t1
f1=$SCR_TMPDIR/f1
mkfifo $f1
# create a vim script file to select/copy the word "root"
printf "/^root\015ve\003:!echo $r > $f1\015:q\015" > $t1
screen -S $session_id -X screen bash -c "vim -s $t1 /etc/passwd"
read ans < $f1
[ "$ans" = $r ]
[ root = $(-clipboard) ]
r=$(-random-string)
# flush clipboard
echo $r | -copy-to-clipboard
[ $r = $(-clipboard) ]
# create a vim script file to select/copy the word "nobody"
printf "/^nobody\015ve\003:!echo $r > $f1\015:q\015" > $t1
cpfile=$SCR_TMPDIR/ssh-cp
# start a control master: check that vim inside gnu screen can handle a
# change in SCR_PORT
-ssh-not-strict -f -N -M -S $cpfile -oBatchMode=yes localhost
# update SCR_PORT
-ssh-not-strict -S $cpfile localhost screen -u -S $session_id -X select -
# try copying a word inside vim to the clipboard over the new SCR_PORT
screen -S $session_id -X screen bash -c "vim -s $t1 /etc/passwd"
read ans < $f1
[ "$ans" = $r ]
[ nobody = $(-clipboard) ]
-ssh-not-strict -N -S $cpfile -O stop localhost
rm $t1 $f1
screen -S $session_id -X quit
