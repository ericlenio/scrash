# vim:filetype=bash
-clear-cache
[ ${#SCR_VIMRC} -gt 0 ]
[ ${#SCR_VIMRUNTIME} -gt 0 ]
[ ! -e $SCR_VIMRC ]
[ ! -e $SCR_VIMRUNTIME ]
[ ${#EDITOR} -gt 0 ]
vim --version >/dev/null
[ -f $SCR_VIMRC ]
[ -d $SCR_VIMRUNTIME ]
[ -e $EDITOR ]
rm $EDITOR
vim --version >/dev/null
[ -e $EDITOR ]
echo ok | -set-clipboard
[ ok = $(-get-clipboard ) ]
t1=$SCR_TMPDIR/t1
t2=$SCR_TMPDIR/t2
t3=$SCR_TMPDIR/t3

printf "/^root\015vey:call ScrSetClipboard(@\")\015:q\015" > $t1
vim -s $t1 /etc/passwd
#'rm $t1
[ root = $(-get-clipboard) ]

s="The quick brown fox jumps over the lazy dog"
echo "$s" | -set-clipboard
[ "$s" = "$(-get-clipboard)" ]
printf ":call ScrPasteClipboard()\015ZZ" > $t1
vim -s $t1 $t2
[ -e $t2 ]
[ "$(<$t2)" = "$s" ]

# test paste in middle of a line
cp $t2 $t3
echo cat | -set-clipboard
[ cat = $(-get-clipboard) ]
printf "/fox\0153x:call ScrPasteClipboard()\015ZZ" > $t1
vim -s $t1 $t3
[ "The quick brown cat jumps over the lazy dog" = "$(<$t3)" ]

# test paste at end of a line
cp $t2 $t3
printf "$:call ScrPasteClipboard()\015ZZ" > $t1
vim -s $t1 $t3
[ "The quick brown fox jumps over the lazy dogcat" = "$(<$t3)" ]

# test pasting multiple lines
s2="line1:aa bb cc
line2"
echo "$s2" > $t3
printf -v s3 "The quick brown\nfox jumps over\nthe lazy dog"
echo "$s3" | -set-clipboard
printf "/bb\015:call ScrPasteClipboard()\015ZZ" > $t1
vim -s $t1 $t3
[ $(wc -l <$t3) = 4 ]
grep '^fox jumps over$' $t3 >/dev/null
grep '^the lazy dogbb cc$' $t3 >/dev/null
[ "$(tail -1 $t3)" = line2 ]

# make sure clipboard.vim exists
[ -d "$SCR_VIMRUNTIME" ]
rm -rf "$SCR_VIMRUNTIME"
printf "/^root\015vey:call ScrSetClipboard(@\")\015:q\015" > $t1
vim -s $t1 /etc/passwd
#'rm $t1
[ root = $(-get-clipboard) ]
