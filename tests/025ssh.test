# vim:filetype=bash
-clear-cache
export SCR_SSH_AUTH_SOCK_SKIP_OPTIMIZATION=1
-sxx-scr-server-known-hosts
[ -f $SCR_SSH_USER_KNOWN_HOSTS ]
if [ "$SCR_SSH_AUTH_SOCK" ]; then
  hostname=$(ssh -oUserKnownHostsFile=$SCR_SSH_USER_KNOWN_HOSTS $SCR_SSH_HOST hostname)
  [ "$hostname" ]
  [ "$hostname" = $(hostname) ]

  # IF THIS FILE WAS RUN ON IT'S OWN (npm t -g ssh), then the above ssh should
  # have deleted $SCR_SSH_USER_KNOWN_HOSTS, because no version file existed
  # (so, there should have been a forced cache clear)
  [ ! -f $SCR_SSH_USER_KNOWN_HOSTS ] && -sxx-scr-server-known-hosts
  [ -f $SCR_SSH_USER_KNOWN_HOSTS ]

  # add in some tests around the version file
  version_file=$SCR_TMPDIR/.version
  [ -f $version_file ]
  rm $version_file
  # this next ssh session should use the same $SCR_TMPDIR, and re-create the
  # version file
  hostname=$(ssh -oUserKnownHostsFile=$SCR_SSH_USER_KNOWN_HOSTS $SCR_SSH_HOST hostname)
  [ "$hostname" = $(hostname) ]
  [ -f $version_file ]

  ssh-add -l
  rm -f /tmp/passwd
  -download /etc/passwd
  [ -f /tmp/passwd ]
  [ $(-md5 /tmp/passwd) = $(-md5 /etc/passwd) ]
  rm /tmp/passwd

  ssh_cmd=(ssh -oUserKnownHostsFile=$SCR_SSH_USER_KNOWN_HOSTS $SCR_SSH_HOST bash -c -- -vars)
  "${ssh_cmd[@]}" | grep -q SCR_TMPDIR

  m1="should_not_see_this_string_because_exec_should_effectively_hide_it"
  t1=$SCR_TMPDIR/ssh_exec_test
  printf "#!/usr/bin/env bash\nset -e\ndeclare -f ssh >/dev/null\n%s\necho '%s'\n" "${ssh_cmd[*]}" "$m1" >$t1
  chmod 755 $t1
  $t1 | grep -q SCR_TMPDIR
  SCR_SSH_EXEC=0 $t1 | grep -q "$m1"
  ! SCR_SSH_EXEC=1 $t1 | grep -q "$m1"
else
  echo "WARNING $(basename $TEST_SOURCE_FILE): skipping some tests, no value for $SCR_SSH_AUTH_SOCK" >&2
fi
SCR_SSH_AUTH_SOCK_SKIP_OPTIMIZATION=0
