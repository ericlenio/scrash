# vim:filetype=bash
# vim/screen/ssh/sudo integration tests
-clear-cache
# use ssh to start a "remote" screen session using a forwarded SCR_PORT value -
# ssh will immediately end and so will the port forward and then below we test
# the ability to reconnect it
session_id=$(-screen-session -r)

# extract the current value of SCR_PORT from the detached screen session
-get-scr-port() {
  local p=$(-screen-pipe -S $session_id bash -c -- '-screen-env -p')
  [[ "$p" =~ ^[0-9]+$ ]]
  echo $p
}

SCR_PORT0=$(-get-scr-port)
t1=$SCR_TMPDIR/t1
t2=$SCR_TMPDIR/t2
t3=$SCR_TMPDIR/t3
f2=$SCR_TMPDIR/f2
logfile=$SCR_TMPDIR/logfile
mkfifo -m 0666 $f2
passwd_user=nobody
r=$(-random-string)
[ ${#r} -gt 0 ]
echo r=$r
# flush clipboard
echo $r | -copy-to-clipboard
[ $r = $(-clipboard) ]



# create a vim script file to select/copy the word "nobody", write to fifo,
# (then we change SCR_PORT behind the scenes), read fifo, copy "root", write to
# fifo, quit vim
printf "/^$passwd_user\015ve\003:call writefile(['$r'],'$f2')\015:call readfile('$f2')\015/^root\015ve\003:call writefile([\$USER],'$f2')\015:q\015" > $t1




cat <<EOF >$t2
screen -X screen bash -c -- "-s $passwd_user vim -s $t1 /etc/passwd"
cat $f2
EOF
ans=$(-ssh-localhost -screen-pipe -u -S $session_id bash $t2)
[ "$ans" = $r ]
[ $passwd_user = $(-clipboard) ]


# flush clipboard
echo $r | -copy-to-clipboard
[ $r = $(-clipboard) ]



# start log file, just in case things go wrong
screen -S $session_id -X eval "logfile $logfile" "log on"




# now change the SCR_PORT of the detached screen session, then continue our vim
# script by writing a line to the fifo
cat <<EOF >$t3
echo > $f2
cat $f2
EOF
ans=$(-ssh-localhost -screen-pipe -u -S $session_id bash $t3)
[ "$ans" = $passwd_user ]
[ root = $(-clipboard) ]


# scr ports should differ, proving we survived a port change
SCR_PORT1=$(-get-scr-port)
[ $SCR_PORT != $SCR_PORT0 ]
[ $SCR_PORT0 != $SCR_PORT1 ]

# this is a test for running ssh inside gnu screen, and that any gnu screen
# dynamic window title output from ssh does not get captured in stdout
ans=$(-ssh-localhost -screen-pipe -u -S $session_id -- ssh -oStrictHostKeyChecking=no -oUserKnownHostsFile=/dev/null localhost uname)
[[ "$ans" = $(uname) ]]


rm $t1
-ssh-localhost -screen-pipe -u -S $session_id -- -ws-hello-world -o $t1
-ssh-localhost -screen-pipe -u -S $session_id -- uname | grep $(uname)
! -ssh-localhost -screen-pipe -u -S $session_id -- false
[ -e $t1 ]
grep -q hello $t1
rm $t1 $t2 $t3 $f2
